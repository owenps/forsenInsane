name: Live Check

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Check if bot is enabled
        id: check_enabled
        run: |
          enabled=$(python -c "import json; print(json.load(open('config.json'))['enabled'])")
          echo "enabled=$enabled" >> $GITHUB_OUTPUT

      - name: Check if live with Minecraft
        if: steps.check_enabled.outputs.enabled == 'True'
        id: check_live
        env:
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
        run: |
          result=$(python -c "
          import json
          import sys
          sys.path.insert(0, '.')
          from src.twitch import check_minecraft_stream

          config = json.load(open('config.json'))
          streamer = config['streamer']

          is_minecraft, stream = check_minecraft_stream(streamer)

          if not stream:
              print(f'{streamer} is offline')
              sys.exit(0)

          if not is_minecraft:
              print(f'{streamer} is playing {stream.get(\"game_name\")}, not Minecraft')
              sys.exit(0)

          print(f'{streamer} is live with Minecraft!')
          print('TRIGGER')
          ")
          echo "$result"
          if echo "$result" | grep -q "TRIGGER"; then
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if Timer Monitor already running
        if: steps.check_live.outputs.should_trigger == 'true'
        id: check_running
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          running=$(gh run list --workflow=check_timer.yml --status=in_progress --json databaseId -q 'length')
          if [ "$running" -gt 0 ]; then
            echo "Timer Monitor already running, skipping"
          else
            echo "No Timer Monitor running, will trigger"
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Timer Monitor workflow
        if: steps.check_running.outputs.should_trigger == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh workflow run check_timer.yml
          echo "Triggered Timer Monitor workflow"
